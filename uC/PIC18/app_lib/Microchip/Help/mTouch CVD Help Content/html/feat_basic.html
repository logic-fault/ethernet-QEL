<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>mTouch Framework: Basic mTouch Sensor Configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="main.html">main</a>      </li>
      <li><a class="el" href="_framework_features.html">Features</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Basic mTouch Sensor Configuration </h1>  </div>
</div>
<div class="contents">
<p>The mTouch Framework scans all sensors in the same basic manner. All sensors (whether normal 'button', part of a slider or wheel, a single row in a matrix, or a proximity sensor) start by being scanned using the mTouch CVD waveform. Once all enabled sensors have a 'final' reading, the data ready flag is set and the decoding routine is called from the main loop.</p>
<h2><a class="anchor" id="featBasic-Config"></a>
Basic mTouch Sensor Configuration</h2>
<ol>
<li>
In the <a class="el" href="m_touch__config_8h.html" title="Framework Configuration! Main configuration file for the mTouch Framework.">mTouch_config.h</a> file, under 'System Setup' start by defining <a class="el" href="group___configuration.html#ga024148e99a7143db044a48216664d03d" title="The oscillator frequency of your system in Hz.">_XTAL_FREQ</a> to the frequency of your processor's oscillator in Hz. This does not set the value of your oscillator - it merely tells the framework what the value is initialized to by your application. </li>
<li>
Set <a class="el" href="group___configuration.html#ga10d20c06688293c970260fa55459b97d" title="Defines the manner in which the framework will integrate with the application.">MTOUCH_INTEGRATION_TYPE</a> to the behavior you desire for your application. <ul>
<li>
<a class="el" href="m_touch__options_for_config_8h.html#a5c81684680ee270c3254b559cb1c2152">MTOUCH_CONTROLS_ISR</a> :: means the framework is the only interrupt in the application </li>
<li>
<a class="el" href="m_touch__options_for_config_8h.html#a6e5fa9e45fbeaaa17d9ebfedd2743ca6">MTOUCH_CALLED_FROM_ISR</a> :: means the application will be calling <a class="el" href="group___acquisition.html#ga60426826e876a6a8c03b27b45ba02833" title="Implements the framework&#39;s active-mode acquisition routine. Sometimes implemented as an ISR...">mTouch_Scan()</a> from its own ISR. </li>
<li>
<a class="el" href="m_touch__options_for_config_8h.html#a2aa2c74747677da6088c9522482e1994">MTOUCH_CALLED_FROM_MAINLOOP</a> :: means the framework will perform scans any time the data-ready flag is checked. </li>
</ul>
</li>
<li>
Set <a class="el" href="group___configuration.html#gaf4dbe0f0b02e92689bb34a139cc9d100" title="Determines how many sensors are scanned in a single &#39;scan&#39; function call.">MTOUCH_SCAN_FUNCTIONALITY</a> to the behavior you desire for your application. <ul>
<li>
<a class="el" href="m_touch__options_for_config_8h.html#a089f9411a02ab3499e185f84aeab1500">MTOUCH_SCANS_ONE_SENSOR</a> :: means the framework only scans a single sensor per <a class="el" href="group___acquisition.html#ga60426826e876a6a8c03b27b45ba02833" title="Implements the framework&#39;s active-mode acquisition routine. Sometimes implemented as an ISR...">mTouch_Scan()</a> call. <ul>
<li>
This is the preferred value. It provides the best noise immunity due to increased jittering. </li>
</ul>
</li>
<li>
<a class="el" href="m_touch__options_for_config_8h.html#a430fd29d69cc10514f11613b4b668e0b">MTOUCH_SCANS_ALL_SENSORS</a> :: means the framework scans all sensors one time per <a class="el" href="group___acquisition.html#ga60426826e876a6a8c03b27b45ba02833" title="Implements the framework&#39;s active-mode acquisition routine. Sometimes implemented as an ISR...">mTouch_Scan()</a> call. <ul>
<li>
This can be chosen to increase the sampling rate of the system. Trade-off: slightly decreased noise robustness </li>
</ul>
</li>
</ul>
</li>
<li>
Under 'Sensor Setup', set <a class="el" href="group___configuration.html#ga120981aeda98930e49691ea39c1b550e" title="Number of active-mode mTouch sensor inputs to scan.">MTOUCH_NUMBER_SENSORS</a> to the number of sensors to scan, in total. <dl class="note"><dt><b>Note:</b></dt><dd>Each sensor is usually a unique analog channel, but this is not required. To minimize the possibility of errors in the mTouch waveform, try not to repeat the same analog channel twice in a row. Also try and avoid having the first and last sensor as the same analog channel. </dd></dl>
</li>
<li>
For each sensor: <ol type="a">
<li>
Set MTOUCH_SENSORx to its corresponding analog channel. <div class="fragment"><pre class="fragment"><span class="preprocessor"> #define MTOUCH_SENSOR0                AN0     // Sensor0 is connected to AN4</span>
</pre></div> </li>
<li>
Set THRESHOLD_PRESS_SENSORx to the threshold value for this sensor. <div class="fragment"><pre class="fragment"><span class="preprocessor"> #define THRESHOLD_PRESS_SENSOR0       100     // Reading must be 100 counts &gt; the baseline</span>
</pre></div> <dl class="note"><dt><b>Note:</b></dt><dd>This value is difficult to determine prior to running the system on the hardware and examining the level of sensitivity. 100-500 is a good default value but may need to be drastically adjusted based on the specific hardware design. </dd></dl>
</li>
</ol>
</li>
<li>
Under 'Filtering', set <a class="el" href="group___configuration.html#ga4c1d9252bcdcc1cb2aa56787cd90cd2b" title="Determines the degree of oversampling and the sample rate of your system.">MTOUCH_SAMPLES_PER_SCAN</a> to the amount of oversampling to perform on each sensor. </li>
<li>
Under 'Decoding', set <a class="el" href="group___configuration.html#ga0698872aa786e004e678466f50777ca9" title="Number of mTouch decode function calls where the sensor is consecutively pressed before resetting the...">MTOUCH_BUTTON_TIMEOUT</a> to the maximum number of consecutive 'pressed' state decisions in a row. After this counter is exceeded, the pressed sensor will be reset to unpressed. This creates a maximum press time and is an easy way to automatically recover from a stuck sensor. </li>
<li>
Set <a class="el" href="group___configuration.html#ga20790a896621aa156c94728c0fa661eb" title="Number of consecutive scans a sensor must be decoded as pressed before changing states.">MTOUCH_DEBOUNCE_PRESS</a> and <a class="el" href="group___configuration.html#gab8e5ed0f0297a6afce2287baa76aedb5" title="Number of consecutive scans a sensor must be decoded as released before changing states.">MTOUCH_DEBOUNCE_RELEASE</a> to the amount of debouncing to implement. </li>
</ol>
<h2><a class="anchor" id="featBasic-Out"></a>
Basic mTouch Sensor API</h2>
<p>First, we will need to set up the application to scan mTouch. To do this, we need to create a check in the main loop to service the mTouch decode function. If we are using mTouch as one of several ISRs, we also need to add the scanning call to our ISR logic.</p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> main(<span class="keywordtype">void</span>)
 {
     myApp_Init();                       <span class="comment">// Your application&#39;s initialization (examples provided in main.c)</span>

     <a class="code" href="m_touch_8c.html#ab73968cbb19d4ae25a65698c15906b65" title="Main initialization routine for all mTouch framework modules including the built-in communication mod...">mTouch_Init</a>();                      <span class="comment">// mTouch initialization</span>

<span class="preprocessor">     #if defined(MCOMM_ENABLED)</span>
<span class="preprocessor"></span>     <a class="code" href="m_comm_8h.html#ae411cd73970859fd79070afa9a1cb319">mComm_Init</a>();                       <span class="comment">// mComm initialization</span>
<span class="preprocessor">     #endif</span>
<span class="preprocessor"></span>
     INTCONbits.GIE = 1;                 <span class="comment">// Initialization complete. Begin servicing interrupts.</span>

     <span class="keywordflow">while</span>(1)
     {
         <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#a102fc3a75223c81493c2c6cd33ad8cb3" title="Sometimes function call, sometimes bit-check. Required mTouch API call.">mTouch_isDataReady</a>())       <span class="comment">// Is new information ready?</span>
         {
             <a class="code" href="m_touch_8h.html#a96203f03b9e8e101c8c59c562c49ef40" title="Performs mTouch decoding, communications output, and mode switching.">mTouch_Service</a>();           <span class="comment">// Decode the newly captured data and transmit new data updates.</span>
             
             <span class="comment">// Application sensor-state logic checks go here.</span>
         }
     }
 }
</pre></div><div class="fragment"><pre class="fragment"> <span class="keywordtype">void</span> interrupt ISR(<span class="keywordtype">void</span>)
 {
     <a class="code" href="m_touch__macro_library__common_8h.html#a85fa8655878434d6083b314e053a684d" title="Executes any required actions to save the current main-loop process.">SAVE_STATE</a>();                       <span class="comment">// mTouch Framework-supplied general ISR save state macro. </span>
                                         <span class="comment">// Not required, but convenient. </span>

<span class="preprocessor">     #if (MTOUCH_INTEGRATION_TYPE == MTOUCH_CALLED_FROM_ISR)</span>
<span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#a92868140881b6503ef6617b8dc0660a1" title="Implements the ISR flag checks to see if the mTouch timer caused the interrupt.">mTouch_checkInterrupt</a>())    <span class="comment">// Checks if the TMRxIE and TMRxIF flags are both equal to 1.</span>
         {
             <a class="code" href="group___acquisition.html#ga60426826e876a6a8c03b27b45ba02833" title="Implements the framework&amp;#39;s active-mode acquisition routine. Sometimes implemented as an ISR...">mTouch_Scan</a>();              <span class="comment">// Required if running as ISR slave. The mTouch timer interrupt </span>
                                         <span class="comment">// flag is cleared inside the mTouch_Scan() function.</span>
         }
<span class="preprocessor">     #elif (MTOUCH_INTEGRATION_TYPE == MTOUCH_CALLED_FROM_MAINLOOP)</span>
<span class="preprocessor"></span>         <a class="code" href="m_touch_8c.html#ab678fb469a6bdd3d0b75cc4b48adf504" title="Tracks the state of the mTouch algorithm.">mTouch_state</a>.isrServiced = 1;   <span class="comment">// Alerts the mTouch scanning routine that an interrupt may </span>
                                         <span class="comment">// have disrupted a scan. This is cleared at the start of a</span>
                                         <span class="comment">// new scan and is checked at the end of the scan.</span>
                                         <span class="comment">// Bad data can affect the readings if this flag is not set.</span>
<span class="preprocessor">     #endif</span>
<span class="preprocessor"></span>     
     
     <a class="code" href="m_touch__macro_library__common_8h.html#af536d4c7b772add24840d3bf8546ea77" title="Executes any required actions to save the current main-loop process.">RESTORE_STATE</a>();                    <span class="comment">// mTouch Framework-supplied general ISR restore state macro. </span>
                                         <span class="comment">// Not required, but convienent.</span>
 }
</pre></div><p>The API for accessing button states is <a class="el" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState(i)</a>. The states have been enumerated with the labels: <a class="el" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a8ac4e988fd74c22ff6e99ee854cc848f" title="Sensor is still initializing.">MTOUCH_INITIALIZING</a>, <a class="el" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2a9171b63f68c2e5ed308f9700e824cbbe" title="Sensor is currently released.">MTOUCH_RELEASED</a>, and <a class="el" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2aed5b3f2b7065991010f45eb04759ef01" title="Sensor is currently pressed.">MTOUCH_PRESSED</a>.</p>
<div class="fragment"><pre class="fragment"> <span class="keywordflow">if</span> (<a class="code" href="m_touch_8h.html#ac3cba3c5b7b2bb8130212e45c77311cc" title="Get the current state of the given active-mode sensor.">mTouch_GetButtonState</a>(0) &lt; <a class="code" href="m_touch_8h.html#a7d72b112c35bc51408030eb7ecdcacd2aed5b3f2b7065991010f45eb04759ef01" title="Sensor is currently pressed.">MTOUCH_PRESSED</a>)
 { 
     LED0 = LED_OFF;                     <span class="comment">// Sensor0 not pressed. Turn off LED.</span>
 } <span class="keywordflow">else</span> { 
     LED0 = LED_ON;                      <span class="comment">// Sensor0 pressed. Turn on LED.</span>
 }
</pre></div> </div>
<hr class="footer"/><address class="footer"><small>mTouch Framework v2.1 documentation by&#160;
<a href="http://www.microchip.com"> 
<img class="footer" src="../includes/mchp.jpeg" alt="Click here to visit our website at www.microchip.com"/></a></small></address> 
</body> 
</html> 
